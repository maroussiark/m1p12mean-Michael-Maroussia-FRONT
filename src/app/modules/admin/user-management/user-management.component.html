<!-- user-management.component.html -->
<div class="p-6 bg-gray-50 min-h-screen">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Gestion des utilisateurs</h1>
        <button pButton pRipple label="Nouvel utilisateur" icon="pi pi-plus" class="p-button-success"
            (click)="openNew()"></button>
    </div>

    <!-- Nouvelle structure des tabs dans PrimeNG v18 -->
    <p-tabs value="0">
        <p-tablist>
            <p-tab value="0">
                Tous les utilisateurs
            </p-tab>
            <p-tab value="1">
                Clients
            </p-tab>
            <p-tab value="2">
                Mécaniciens
            </p-tab>
            <p-tab value="3">
                Historique des activités
            </p-tab>

        </p-tablist>

        <p-tabpanels>
            <!-- Panneau "Tous les utilisateurs" -->
            <p-tabpanel value="0">
                <div class="mb-4 flex justify-between items-center">
                    <div class="p-input-icon-left w-full md:w-1/3">
                        <i class="pi pi-search"></i>
                        <input type="text" pInputText placeholder="Rechercher un utilisateur..."
                            (input)="filterUsers($event)" class="w-full p-inputtext-sm" />
                    </div>
                    <!-- Remplacer p-dropdown par p-select -->
                    <p-select [options]="userTypes" placeholder="Type d'utilisateur" [showClear]="true"
                        class="ml-2"></p-select>
                    <p-select [options]="statuts" placeholder="Statut" [showClear]="true" class="ml-2"></p-select>
                </div>

                <p-table [value]="filteredUsers" [rows]="10" [paginator]="true" responsiveLayout="scroll"
                    styleClass="p-datatable-sm p-datatable-gridlines" [rowHover]="true"
                    currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} utilisateurs"
                    [showCurrentPageReport]="true">
                    <ng-template pTemplate="header">
                        <tr>
                            <th pSortableColumn="id" style="width: 5%">ID <p-sortIcon field="id"></p-sortIcon></th>
                            <th pSortableColumn="nom" style="width: 15%">Nom <p-sortIcon field="nom"></p-sortIcon></th>
                            <th pSortableColumn="email" style="width: 20%">Email <p-sortIcon field="email"></p-sortIcon>
                            </th>
                            <th pSortableColumn="telephone" style="width: 15%">Téléphone <p-sortIcon
                                    field="telephone"></p-sortIcon></th>
                            <th pSortableColumn="type" style="width: 10%">Type <p-sortIcon field="type"></p-sortIcon>
                            </th>
                            <th pSortableColumn="statut" style="width: 10%">Statut <p-sortIcon
                                    field="statut"></p-sortIcon></th>
                            <th pSortableColumn="dateCreation" style="width: 15%">Date de création <p-sortIcon
                                    field="dateCreation"></p-sortIcon></th>
                            <th style="width: 10%">Actions</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-user>
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.prenom }} {{ user.nom }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.telephone }}</td>
                            <td>
                                <span class="capitalize">{{ user.type }}</span>
                            </td>
                            <td>
                                <span class="px-3 py-1 rounded-full text-xs font-medium"
                                    [ngClass]="getUserStatutClass(user.statut)">
                                    {{ user.statut === 'actif' ? 'Actif' : user.statut === 'inactif' ? 'Inactif' : 'En attente' }}
                                </span>
                            </td>
                            <td>{{ user.dateCreation | date:'dd/MM/yyyy' }}</td>
                            <td>
                                <div class="flex justify-around">
                                    <button pButton pRipple icon="pi pi-pencil"
                                        class="p-button-rounded p-button-text p-button-sm"
                                        (click)="editUser(user)"></button>
                                    <button pButton pRipple icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                        (click)="deleteUser(user)"></button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="8" class="text-center p-4">Aucun utilisateur trouvé.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>

            <!-- Panneau "Clients" -->
            <p-tabpanel value="1">
                <!-- Nouvelle structure d'Accordion -->
                <p-accordion [multiple]="true" styleClass="mb-4">
                    <div class="p-accordion-item">
                        <div class="p-accordion-header">
                            <a role="button">Filtres avancés</a>
                        </div>
                        <div class="p-accordion-content">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="p-field">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Date
                                        d'inscription</label>
                                    <!-- Remplacer p-calendar par p-datePicker -->
                                    <p-datePicker selectionMode="range" [showButtonBar]="true"
                                        placeholder="Sélectionner une période" [readonlyInput]="true"
                                        class="w-full"></p-datePicker>
                                </div>
                                <div class="p-field">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de
                                        visites</label>
                                    <p-slider [range]="true" [min]="0" [max]="20" class="w-full"
                                        [(ngModel)]="visiteRange" [ngModelOptions]="{standalone: true}"></p-slider>
                                </div>
                                <div class="p-field">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Valeur totale des
                                        services</label>
                                    <p-slider [range]="true" [min]="0" [max]="2000" class="w-full"
                                        [(ngModel)]="valeurRange" [ngModelOptions]="{standalone: true}"></p-slider>
                                </div>
                            </div>
                            <div class="flex justify-end mt-3">
                                <button pButton label="Appliquer les filtres" icon="pi pi-filter"
                                    class="p-button-sm"></button>
                            </div>
                        </div>
                    </div>
                </p-accordion>

                <p-table
                    [value]="clients"
                    dataKey="id"
                    [rows]="10"
                    [paginator]="true"
                    responsiveLayout="scroll"
                    [rowHover]="true"
                    styleClass="p-datatable-sm p-datatable-gridlines"
                    [expandedRowKeys]="expandedRows"
                    (onRowExpand)="onRowExpand($event)"
                    (onRowCollapse)="onRowCollapse($event)"
                    >
                    <ng-template #header pTemplate="header">
                        <tr>
                            <th style="width: 3%"></th>
                            <th pSortableColumn="nom" style="width: 15%">Nom <p-sortIcon field="nom"></p-sortIcon></th>
                            <th pSortableColumn="email" style="width: 20%">Email <p-sortIcon field="email"></p-sortIcon>
                            </th>
                            <th pSortableColumn="telephone" style="width: 15%">Téléphone <p-sortIcon
                                    field="telephone"></p-sortIcon></th>
                            <th pSortableColumn="nombreVisites" style="width: 10%">Visites <p-sortIcon
                                    field="nombreVisites"></p-sortIcon></th>
                            <th pSortableColumn="valeurTotale" style="width: 12%">Valeur <p-sortIcon
                                    field="valeurTotale"></p-sortIcon></th>
                            <th pSortableColumn="statut" style="width: 10%">Statut <p-sortIcon
                                    field="statut"></p-sortIcon></th>
                            <th style="width: 15%">Actions</th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-client let-expanded="expanded">
                        <tr>
                            <td>
                                <p-button type="button"
                                    pRipple
                                    [pRowToggler]="client"
                                    [rounded]="true"
                                    [text]="true"
                                    [plain]="true"
                                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
                                </p-button>
                            </td>
                            <td>{{ client.prenom }} {{ client.nom }}</td>
                            <td>{{ client.email }}</td>
                            <td>{{ client.telephone }}</td>
                            <td>{{ client.nombreVisites }}</td>
                            <td>{{ client.valeurTotale }} €</td>
                            <td>
                                <span class="px-3 py-1 rounded-full text-xs font-medium"
                                    [ngClass]="getUserStatutClass(client.statut)">
                                    {{ client.statut === 'actif' ? 'Actif' : client.statut === 'inactif' ? 'Inactif' :
                                    'En attente' }}
                                </span>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button pButton pRipple icon="pi pi-pencil"
                                        class="p-button-rounded p-button-text p-button-sm"
                                        (click)="editUser(client)"></button>
                                    <button pButton pRipple icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                        (click)="deleteUser(client)"></button>
                                    <button pButton pRipple icon="pi pi-history" pTooltip="Historique"
                                        tooltipPosition="top"
                                        class="p-button-rounded p-button-text p-button-info p-button-sm"></button>
                                    <button pButton pRipple icon="pi pi-car" pTooltip="Véhicules" tooltipPosition="top"
                                        class="p-button-rounded p-button-text p-button-success p-button-sm"></button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template #expandedrow  let-client>
                        <tr>
                            <td colspan="8">
                                <div class="p-3 bg-gray-50 rounded">
                                    <h3 class="text-lg font-semibold mb-2">Véhicules</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <div *ngFor="let vehicule of client.vehicules"
                                            class="bg-white p-3 rounded-lg shadow-sm flex items-center">
                                            <i class="pi pi-car text-xl mr-3 text-blue-500"></i>
                                            <span>{{ vehicule }}</span>
                                        </div>
                                        <div
                                            class="bg-white p-3 rounded-lg shadow-sm border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-500 cursor-pointer">
                                            <i class="pi pi-plus mr-2"></i> Ajouter un véhicule
                                        </div>
                                    </div>

                                    <h3 class="text-lg font-semibold mt-4 mb-2">Activités récentes</h3>
                                    <p-timeline [value]="getUserActivities(client.id)" align="alternate"
                                        styleClass="mt-3">
                                        <ng-template pTemplate="content" let-activite>
                                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                                <p class="font-medium">{{ activite.action }}</p>
                                                <p class="text-sm text-gray-600">{{ activite.details }}</p>
                                                <small class="text-gray-500">{{ activite.date | date:'dd/MM/yyyy HH:mm'
                                                    }}</small>
                                            </div>
                                        </ng-template>
                                        <ng-template pTemplate="opposite" let-activite>
                                            <div class="text-sm font-medium"
                                                [ngClass]="{'text-blue-600': activite.action === 'Connexion', 'text-green-600': activite.action === 'Prise de rendez-vous'}">
                                                {{ activite.action }}
                                            </div>
                                        </ng-template>
                                    </p-timeline>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="8" class="text-center p-4">Aucun client trouvé.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>

            <!-- Panneau "Mécaniciens" -->
            <p-tabpanel value="2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <p-card *ngFor="let mecanicien of mecaniciens" styleClass="shadow-md">
                        <ng-template pTemplate="header">
                            <div class="bg-blue-50 p-4 flex justify-between items-center">
                                <div class="flex items-center">
                                    <div
                                        class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl font-bold">
                                        {{ mecanicien.prenom[0] }}{{ mecanicien.nom[0] }}
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-lg font-semibold">{{ mecanicien.prenom }} {{ mecanicien.nom }}
                                        </h3>
                                        <p class="text-sm text-gray-600">{{ mecanicien.email }}</p>
                                    </div>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs"
                                    [ngClass]="mecanicien.disponibilite ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                    {{ mecanicien.disponibilite ? 'Disponible' : 'Occupé' }}
                                </span>
                            </div>
                        </ng-template>

                        <div class="mb-4">
                            <p class="font-medium mb-2">Spécialités:</p>
                            <div class="flex flex-wrap gap-2">
                                <p-chip *ngFor="let specialite of mecanicien.specialites" [label]="specialite"
                                    styleClass="mr-2"></p-chip>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600">Téléphone</p>
                                <p class="font-medium">{{ mecanicien.telephone }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Interventions</p>
                                <p class="font-medium">{{ mecanicien.nombreInterventions }}</p>
                            </div>
                        </div>

                        <ng-template pTemplate="footer">
                            <div class="flex justify-between">
                                <button pButton label="Historique" icon="pi pi-history"
                                    class="p-button-outlined p-button-sm"></button>
                                <div>
                                    <button pButton icon="pi pi-pencil"
                                        class="p-button-rounded p-button-text p-button-sm mr-2"
                                        (click)="editUser(mecanicien)"></button>
                                    <button pButton icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                        (click)="deleteUser(mecanicien)"></button>
                                </div>
                            </div>
                        </ng-template>
                    </p-card>
                </div>
            </p-tabpanel>

            <!-- Panneau "Historique des activités" -->
            <p-tabpanel value="3">
                <div class="mb-4 flex flex-wrap gap-2">
                    <p-select [options]="userTypes" placeholder="Filtrer par type" [showClear]="true"></p-select>
                    <p-select [options]="[
              {label: 'Connexion', value: 'connexion'},
              {label: 'Prise de rendez-vous', value: 'rendez-vous'},
              {label: 'Modification', value: 'modification'}
            ]" placeholder="Type d'activité" [showClear]="true"></p-select>
                    <p-datePicker [showIcon]="true" placeholder="Date de début" [showButtonBar]="true"></p-datePicker>
                    <p-datePicker [showIcon]="true" placeholder="Date de fin" [showButtonBar]="true"></p-datePicker>
                    <button pButton label="Filtrer" icon="pi pi-filter" class="p-button-sm"></button>
                </div>

                <p-timeline [value]="activites" align="alternate" styleClass="mt-6">
                    <ng-template pTemplate="marker" let-activite>
                        <span class="flex h-10 w-10 items-center justify-center rounded-full" [ngClass]="{
                  'bg-blue-100': activite.action === 'Connexion',
                  'bg-green-100': activite.action === 'Prise de rendez-vous',
                  'bg-yellow-100': activite.action === 'Mise à jour intervention',
                  'bg-purple-100': activite.action === 'Modification utilisateur'
                }">
                            <i class="text-lg" [ngClass]="{
                    'pi pi-sign-in': activite.action === 'Connexion',
                    'pi pi-calendar': activite.action === 'Prise de rendez-vous',
                    'pi pi-cog': activite.action === 'Mise à jour intervention',
                    'pi pi-user-edit': activite.action === 'Modification utilisateur'
                  }" [class.text-blue-600]="activite.action === 'Connexion'"
                                [class.text-green-600]="activite.action === 'Prise de rendez-vous'"
                                [class.text-yellow-600]="activite.action === 'Mise à jour intervention'"
                                [class.text-purple-600]="activite.action === 'Modification utilisateur'">
                            </i>
                        </span>
                    </ng-template>
                    <ng-template pTemplate="content" let-activite>
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4" [ngClass]="{
                  'border-blue-500': activite.action === 'Connexion',
                  'border-green-500': activite.action === 'Prise de rendez-vous',
                  'border-yellow-500': activite.action === 'Mise à jour intervention',
                  'border-purple-500': activite.action === 'Modification utilisateur'
                }">
                            <p class="font-medium">{{ activite.action }}</p>
                            <p class="text-sm text-gray-600 mt-1">{{ activite.details }}</p>
                            <div class="flex justify-between items-center mt-2">
                                <div class="text-sm font-medium text-blue-600">{{ activite.userName }}</div>
                                <div class="text-xs text-gray-500">{{ activite.date | date:'dd/MM/yyyy HH:mm' }}</div>
                            </div>
                        </div>
                    </ng-template>
                </p-timeline>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>
</div>

<!-- Dialogue de création/modification d'utilisateur -->
<p-dialog [(visible)]="userDialog" [style]="{width: '700px'}" header="Détails de l'utilisateur" [modal]="true"
    styleClass="p-fluid" [draggable]="false" [resizable]="false">

    <form [formGroup]="userForm" class="p-fluid">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="field">
                <label for="nom" class="font-medium">Nom</label>
                <input type="text" pInputText id="nom" formControlName="nom" required autofocus
                    [ngClass]="{'ng-invalid ng-dirty': submitted && userForm.controls['nom'].invalid}" />
                <small class="text-red-500" *ngIf="submitted && userForm.controls['nom'].invalid">Le nom est
                    requis.</small>
            </div>

            <div class="field">
                <label for="prenom" class="font-medium">Prénom</label>
                <input type="text" pInputText id="prenom" formControlName="prenom" required
                    [ngClass]="{'ng-invalid ng-dirty': submitted && userForm.controls['prenom'].invalid}" />
                <small class="text-red-500" *ngIf="submitted && userForm.controls['prenom'].invalid">Le prénom est
                    requis.</small>
            </div>

            <div class="field">
                <label for="email" class="font-medium">Email</label>
                <input type="email" pInputText id="email" formControlName="email" required
                    [ngClass]="{'ng-invalid ng-dirty': submitted && userForm.controls['email'].invalid}" />
                <small class="text-red-500" *ngIf="submitted && userForm.controls['email'].invalid">L'email est requis
                    et doit être valide.</small>
            </div>

            <div class="field">
                <label for="telephone" class="font-medium">Téléphone</label>
                <input type="text" pInputText id="telephone" formControlName="telephone" required
                    [ngClass]="{'ng-invalid ng-dirty': submitted && userForm.controls['telephone'].invalid}" />
                <small class="text-red-500" *ngIf="submitted && userForm.controls['telephone'].invalid">Le téléphone est
                    requis.</small>
            </div>

            <div class="field">
                <label for="type" class="font-medium">Type</label>
                <p-select id="type" [options]="userTypes" formControlName="type" [filter]="true" filterBy="label"
                    [showClear]="false" placeholder="Sélectionner un type" optionLabel="label"
                    optionValue="value"></p-select>
            </div>

            <div class="field">
                <label for="statut" class="font-medium">Statut</label>
                <p-select id="statut" [options]="statuts" formControlName="statut" [filter]="true" filterBy="label"
                    [showClear]="false" placeholder="Sélectionner un statut" optionLabel="label"
                    optionValue="value"></p-select>
            </div>

            <div class="field col-span-2" *ngIf="userForm.get('type')?.value === 'mecanicien'">
                <label for="specialites" class="font-medium">Spécialités</label>
                <p-multiSelect id="specialites" [options]="specialites" formControlName="specialites"
                    defaultLabel="Sélectionner des spécialités" optionLabel="name" display="chip"></p-multiSelect>
            </div>

            <div class="field col-span-2" *ngIf="userForm.get('type')?.value === 'admin'">
                <p-fieldset legend="Droits d'accès" [toggleable]="true" formGroupName="droitsAcces">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                        <div class="field-checkbox">
                            <p-checkbox formControlName="gestionClients" [binary]="true"
                                inputId="gestionClients"></p-checkbox>
                            <label for="gestionClients" class="ml-2">Gestion des clients</label>
                        </div>
                        <div class="field-checkbox">
                            <p-checkbox formControlName="gestionMecaniciens" [binary]="true"
                                inputId="gestionMecaniciens"></p-checkbox>
                            <label for="gestionMecaniciens" class="ml-2">Gestion des mécaniciens</label>
                        </div>
                        <div class="field-checkbox">
                            <p-checkbox formControlName="gestionServices" [binary]="true"
                                inputId="gestionServices"></p-checkbox>
                            <label for="gestionServices" class="ml-2">Gestion des services</label>
                        </div>
                        <div class="field-checkbox">
                            <p-checkbox formControlName="gestionStock" [binary]="true"
                                inputId="gestionStock"></p-checkbox>
                            <label for="gestionStock" class="ml-2">Gestion du stock</label>
                        </div>
                        <div class="field-checkbox">
                            <p-checkbox formControlName="gestionFacturation" [binary]="true"
                                inputId="gestionFacturation"></p-checkbox>
                            <label for="gestionFacturation" class="ml-2">Gestion de la facturation</label>
                        </div>
                    </div>
                </p-fieldset>
            </div>
        </div>
    </form>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Annuler" icon="pi pi-times" class="p-button-text"
            (click)="hideDialog()"></button>
        <button pButton pRipple label="Enregistrer" icon="pi pi-check" class="p-button-text"
            (click)="saveUser()"></button>
    </ng-template>
</p-dialog>

<!-- Dialogue de confirmation de suppression -->
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

<!-- Messages toast -->
<p-toast></p-toast>
